name: Preview deployment
on:
  pull_request:
    paths:
      - 'front-end/**'

defaults:
  run:
    working-directory: frontend

jobs:
  deploy:
    name: Deploy to preview
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Create deployment
      uses: bobheadxi/deployments@v0.6.2
      id: deployment
      with:
        step: start
        token: ${{ secrets.GITHUB_TOKEN }}
        env: preview

    - name: Run front-end tests
      run: yarn test

    - name: Front-end deployment
      if: vercel-deployment
      uses: amondnet/vercel-action@v20
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        github-token: ${{ secrets.GITHUB_TOKEN }} 
        scope: ${{ secrets.VERCEL_TEAM_ID }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID}}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID}} 

    - name: Update deployment status
      uses: bobheadxi/deployments@v0.6.2
      if: always()
      with:
        step: finish
        token: ${{ secrets.GITHUB_TOKEN }}
        status: ${{ job.status }}
        env_url: ${{ steps.vercel-deployment.outputs.preview-url }}
        deployment_id: ${{ steps.deployment.outputs.deployment_id }}
