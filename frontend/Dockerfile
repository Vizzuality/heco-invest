FROM node:16.14-bullseye

# Next.js collects completely anonymous telemetry data about general usage.
# Learn more here: https://nextjs.org/telemetry
# Uncomment the following line in case you want to disable telemetry during the build.
ENV NEXT_TELEMETRY_DISABLED 1
ENV NODE_ENV production

ARG TRANSIFEX_TOKEN
ENV TX_TOKEN $TRANSIFEX_TOKEN

ARG NEXT_PUBLIC_FRONTEND_URL
ENV NEXT_PUBLIC_FRONTEND_URL $NEXT_PUBLIC_FRONTEND_URL

ARG NEXT_PUBLIC_BACKEND_URL
ENV NEXT_PUBLIC_BACKEND_URL $NEXT_PUBLIC_BACKEND_URL

ARG NEXT_PUBLIC_GOOGLE_ANALYTICS
ENV NEXT_PUBLIC_GOOGLE_ANALYTICS $NEXT_PUBLIC_GOOGLE_ANALYTICS

ARG NEXT_PUBLIC_HOTJAR_SITE_ID
ENV NEXT_PUBLIC_HOTJAR_SITE_ID $NEXT_PUBLIC_HOTJAR_SITE_ID

ARG NEXT_PUBLIC_USER_TESTING_FORM_URL
ENV NEXT_PUBLIC_USER_TESTING_FORM_URL $NEXT_PUBLIC_USER_TESTING_FORM_URL

ARG NEXT_PUBLIC_PROXY_BACKEND
ENV NEXT_PUBLIC_PROXY_BACKEND $NEXT_PUBLIC_PROXY_BACKEND

ARG NEXT_PUBLIC_GOOGLE_MAPS_API_KEY
ENV NEXT_PUBLIC_GOOGLE_MAPS_API_KEY $NEXT_PUBLIC_GOOGLE_MAPS_API_KEY

ARG NEXT_PUBLIC_MAPBOX_API_TOKEN
ENV NEXT_PUBLIC_MAPBOX_API_TOKEN $NEXT_PUBLIC_MAPBOX_API_TOKEN

ARG HTTP_AUTH_USERNAME
ENV HTTP_AUTH_USERNAME $HTTP_AUTH_USERNAME

ARG HTTP_AUTH_PASSWORD
ENV HTTP_AUTH_PASSWORD $HTTP_AUTH_PASSWORD

RUN addgroup --system --gid 1001 nextjs
RUN adduser --system --uid 1001 nextjs

RUN apt-get install -y curl bash

RUN curl -o- https://raw.githubusercontent.com/transifex/cli/v1.4.1/install.sh | bash

WORKDIR /app
RUN chown nextjs:nextjs /app

RUN corepack enable

USER nextjs

COPY --chown=nextjs:nextjs . .

RUN yarn install --immutable

RUN /tx pull -f

RUN yarn build

EXPOSE 3000

ENV PORT 3000

ENTRYPOINT ["./entrypoint.sh"]
